parameters:
    oro_userpro.form.type.role_organization_select.class: Oro\Bundle\UserProBundle\Form\Type\RoleOrganizationSelectType
    oro_userpro.autocomplete.role_organization_search_handler.class: Oro\Bundle\UserProBundle\Autocomplete\RoleOrganizationSearchHandler
    oro_userpro.event_listener.datagrid.role.class: Oro\Bundle\UserProBundle\EventListener\Datagrid\RoleListener
    oro_userpro.acl.voter.role.class: Oro\Bundle\UserProBundle\Acl\Voter\RoleVoter
    oro_userpro.helper.class: Oro\Bundle\UserProBundle\Helper\UserProHelper
    oro_userpro.form.type.extension.user.class: Oro\Bundle\UserProBundle\Form\Extension\UserTypeExtension

    # Override class used in oro_user.datagrid.datasource.role_permission_datasource service
    oro_user.datagrid.datasource.role_permission_datasource.class: Oro\Bundle\UserProBundle\Datagrid\RolePermissionDatasource

services:
    oro_userpro.form.type.role_organization_select:
        class: %oro_userpro.form.type.role_organization_select.class%
        arguments:
            - "@security.token_storage"
            - "@oro_userpro.helper"
            - "@oro_organizationpro.helper"
        tags:
            - { name: form.type, alias: oro_userpro_role_organization_select }

    oro_userpro.autocomplete.role_organization_search_handler:
        class: %oro_userpro.autocomplete.role_organization_search_handler.class%
        arguments:
            - "@oro_organization.autocomplete.organization_search_handler"
            - "@security.token_storage"
            - "@oro_organizationpro.helper"
        tags:
            - { name: oro_form.autocomplete.search_handler, alias: oro_userpro_role_organizations }
        lazy: true

    oro_userpro.event_listener.datagrid.role:
        class: %oro_userpro.event_listener.datagrid.role.class%
        arguments:
            - "@oro_userpro.helper"
            - "@oro_organizationpro.helper"
            - "@security.token_storage"
        tags:
            - { name: kernel.event_listener, event: oro_datagrid.datagrid.build.before.roles-grid, method: onBuildBefore }

    oro_userpro.acl.voter.role:
        class: %oro_userpro.acl.voter.role.class%
        arguments:
            - "@oro_userpro.helper"
            - "@oro_organizationpro.helper"
        tags:
            - { name: security.voter, priority: 100 }

    oro_userpro.helper:
        class: %oro_userpro.helper.class%
        arguments:
            - "@security.token_storage"

    oro_userpro.form.type.extension.user:
        class: %oro_userpro.form.type.extension.user.class%
        arguments:
            - "@doctrine"
            - "@translator"
        tags:
            - { name: form.type_extension, alias: oro_user_user }

    # Datagrid
    oro_userpro.user.datagrid_view_list:
        class: Oro\Bundle\UserProBundle\Datagrid\UserProViewList
        parent: 'oro_user.user.datagrid_view_list'

    # Security

    oro_userpro.security.user_checker.decorator:
        decorates: security.user_checker
        class: Oro\Bundle\UserProBundle\Security\UserChecker
        public: false
        arguments:
            - '@oro_userpro.security.user_checker.decorator.inner'

    oro_userpro.mailer.processor:
        class: Oro\Bundle\UserProBundle\Mailer\Processor
        arguments:
            - '@doctrine'
            - '@oro_config.global'
            - '@oro_email.email_renderer'
            - '@oro_email.email_holder_helper'
            - '@oro_email.direct_mailer'

    oro_userpro.security.login_attempts_reset.listener:
        class: Oro\Bundle\UserProBundle\EventListener\LoginAttemptsResetListener
        tags:
            - { name: doctrine.event_listener, event: prePersist }
            - { name: doctrine.event_listener, event: preUpdate }

    oro_userpro.security.login_attempts_provider:
        class: Oro\Bundle\UserProBundle\Security\LoginAttemptsProvider
        arguments:
            - '@oro_config.user'

    oro_userpro.security.login_attempts_manager:
        class: Oro\Bundle\UserProBundle\Security\LoginAttemptsManager
        arguments:
            - '@oro_userpro.security.login_attempts_provider'
            - '@oro_user.manager'
            - '@oro_userpro.mailer.processor'
            - '@logger'

    oro_userpro.security.login_attempts_subscriber:
        class: Oro\Bundle\UserProBundle\EventListener\LoginAttemptsSubscriber
        arguments:
            - '@oro_user.manager'
            - '@oro_userpro.security.login_attempts_manager'
            - '@oro_userpro.security.login_attempts_provider'
        tags:
            - { name: kernel.event_subscriber }

    oro_userpro.validator.password_already_used:
        class: Oro\Bundle\UserProBundle\Validator\UsedPasswordValidator
        arguments:
            - '@doctrine'
            - '@oro_userpro.provider.used_password_config_provider'
            - '@security.encoder_factory'
        tags:
            - { name: validator.constraint_validator, alias: oro_used_password }

    oro_userpro.config.listener:
        class: Oro\Bundle\UserProBundle\EventListener\PasswordExpiryPeriodChangeListener
        arguments:
            - '@doctrine'
            - '@oro_userpro.provider.password_change_period_config_provider'
        tags:
            - { name: kernel.event_listener, event: oro_config.update_after, method: onConfigUpdate }

    oro_userpro.security.password_expiry_subscriber:
        class: Oro\Bundle\UserProBundle\EventListener\PasswordExpiryWarnSubscriber
        arguments:
            - '@oro_userpro.provider.password_change_period_config_provider'
            - '@session'
            - '@translator'
        tags:
            - { name: kernel.event_subscriber }

    oro_userpro.listener.password_history_listener:
        class: Oro\Bundle\UserProBundle\EventListener\PasswordHistoryListener
        tags:
            - { name: doctrine.event_listener, event: onFlush, priority: 200 }

    oro_userpro.provider.used_password_config_provider:
        class: Oro\Bundle\UserProBundle\Provider\UsedPasswordConfigProvider
        arguments:
            - '@oro_config.manager'

    oro_userpro.listener.password_expiration_subscriber:
        class: Oro\Bundle\UserProBundle\EventListener\PasswordExpirySubscriber
        arguments:
            - '@oro_userpro.provider.password_change_period_config_provider'
        tags:
            - { name: doctrine.event_subscriber }

    oro_userpro.provider.password_change_period_config_provider:
        class: Oro\Bundle\UserProBundle\Provider\PasswordChangePeriodConfigProvider
        arguments:
            - '@oro_config.manager'

    # message queue

    oro_userpro.async.expire_user_passwords:
        class: 'Oro\Bundle\UserProBundle\Async\ExpireUserPasswordsProcessor'
        arguments:
            - '@oro_message_queue.client.message_producer'
            - '@logger'
        tags:
            - { name: 'oro_message_queue.client.message_processor' }

    oro_userpro.async.expire_user_password:
        class: 'Oro\Bundle\UserProBundle\Async\ExpireUserPasswordProcessor'
        arguments:
            - '@oro_notification.manager.email_notification'
            - '@oro_user.manager'
            - '@doctrine'
            - '@oro_message_queue.job.runner'
            - '@logger'
        tags:
            - { name: 'oro_message_queue.client.message_processor' }

    oro_userpro.provider.tfa_config_provider:
        class: Oro\Bundle\UserProBundle\Provider\TFAConfigProvider
        arguments:
            - '@oro_config.manager'

    oro_userpro.provider.client_data:
        class: Oro\Bundle\UserProBundle\Provider\ClientDataProvider
        lazy: true
        arguments:
            - '@request_stack'

    oro_userpro.entity.client_data_manager:
        class: Oro\Bundle\UserProBundle\Manager\ClientDataManager
        arguments:
            - '@doctrine'
            - '@oro_userpro.provider.client_data'

    oro_userpro.security.authentication.two_factor_token_factory:
        class: Oro\Bundle\UserProBundle\Security\TwoFactorTokenFactory
        arguments:
            - '@oro_userpro.provider.tfa_config_provider'
        public: false

    oro_userpro.security.authentication.manager_decorator:
        class: Oro\Bundle\UserProBundle\Security\AuthenticationProviderManager
        decorates: security.authentication.manager
        arguments:
            - '@oro_userpro.security.authentication.manager_decorator.inner'
            - '@oro_userpro.security.authentication.two_factor_token_factory'
            - '@oro_userpro.provider.tfa_config_provider'
            - '@oro_userpro.entity.client_data_manager'
            - '@event_dispatcher'
        public: false

    oro_userpro.event_listener.two_factor_subscriber:
        class: Oro\Bundle\UserProBundle\EventListener\TwoFactorAuthenticationSubscriber
        arguments:
            - '@oro_userpro.manager.two_factor_code'
            - '@oro_userpro.sender.two_factor_code_sender'
        tags:
            - { name: kernel.event_subscriber }

    oro_userpro.security.authentication.trust_resolver_decorator:
        class: Oro\Bundle\UserProBundle\Security\AuthenticationTrustResolver
        decorates: security.authentication.trust_resolver
        arguments: ['@oro_userpro.security.authentication.trust_resolver_decorator.inner']
        public: false

    oro_userpro.security.authentication.two_factor_listener:
        class: Oro\Bundle\UserProBundle\Security\TwoFactorAuthListener
        parent: 'security.authentication.listener.abstract'
        abstract: true

    oro_userpro.mailer.two_factor_transport:
        class: Oro\Bundle\UserProBundle\Mailer\TwoFactorMailerTransport
        public: false
        arguments:
            - '@oro_userpro.mailer.processor'
            - '@logger'

    oro_userpro.sender.two_factor_code_sender:
        class: Oro\Bundle\UserProBundle\Sender\TwoFactorCodeSender
        public: false
        arguments:
            - '@oro_userpro.provider.client_data'
            - '@oro_userpro.mailer.two_factor_transport'

    oro_userpro.manager.two_factor_code:
        class: Oro\Bundle\UserProBundle\Manager\TwoFactorCodeManager
        public: false
        arguments:
            - '@doctrine'
            - '@oro_userpro.provider.tfa_config_provider'

    oro_userpro.security.authentication.two_factor_provider:
        class: Oro\Bundle\UserProBundle\Security\TwoFactorAuthProvider
        public: false
        arguments:
            - '@oro_userpro.manager.two_factor_code'
            - '@oro_userpro.entity.client_data_manager'
            - '' # user provider
            - '' # provider key
